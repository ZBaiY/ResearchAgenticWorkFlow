#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
AGENTHUB="$ROOT/bin/agenthub"
INDEX_FILE="$ROOT/AGENTS/runtime/skills_index.json"

usage() {
  cat <<'USAGE'
Usage: ./bin/agent --client <codex|claude|gemini> [--no-launch] [--help]
USAGE
}

CLIENT=""
NO_LAUNCH=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --client)
      CLIENT="${2:-}"
      shift 2
      ;;
    --no-launch)
      NO_LAUNCH=1
      shift
      ;;
    --help|-h)
      usage
      exit 0
      ;;
    *)
      echo "ERROR=Unknown option: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
done

if [[ -z "$CLIENT" ]]; then
  echo "ERROR=--client is required" >&2
  usage >&2
  exit 2
fi

case "$CLIENT" in
  codex|claude|gemini) ;;
  *)
    echo "ERROR=Unknown client '$CLIENT'. Allowed: codex|claude|gemini" >&2
    exit 2
    ;;
esac

if [[ ! -x "$AGENTHUB" ]]; then
  echo "ERROR=Missing executable bin/agenthub" >&2
  exit 1
fi

echo "BOOTSTRAP=doctor"
"$AGENTHUB" doctor

NEED_INDEX=0
if [[ ! -f "$INDEX_FILE" ]]; then
  NEED_INDEX=1
elif find "$ROOT/AGENTS/skills" -type f -name 'skill.yaml' -newer "$INDEX_FILE" | grep -q .; then
  NEED_INDEX=1
fi

if [[ "$NEED_INDEX" -eq 1 ]]; then
  echo "BOOTSTRAP=index_rebuilt"
  "$AGENTHUB" index
else
  echo "BOOTSTRAP=index_fresh"
fi

echo "NEXT=./bin/ask \"your request\""
echo "ALT=./bin/agenthub suggest \"your request\""
echo "EXAMPLE=./bin/ask \"rewrite Floquet section for PRL clarity\""
echo "REPO_ROOT=$ROOT"

if [[ "$NO_LAUNCH" -eq 1 ]]; then
  echo "PATH_INJECTED=\"$REPO_ROOT\""
  echo "LAUNCH=skipped"
  exit 0
fi

export PATH="$REPO_ROOT:$PATH"
echo "PATH_INJECTED=\"$REPO_ROOT\""
echo "LAUNCH=exec $CLIENT"
exec "$CLIENT"
