#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ $# -lt 1 ]]; then
  echo "Usage: ./bin/ask \"<free text request>\"" >&2
  exit 2
fi

QUERY="$*"

set +e
SUGGEST_OUT="$($ROOT/bin/agenthub suggest "$QUERY" 2>&1)"
SUGGEST_RC=$?
set -e
if [[ "$SUGGEST_RC" -ne 0 ]]; then
  SHORT="$(printf '%s\n' "$SUGGEST_OUT" | tail -n 1)"
  [[ -n "$SHORT" ]] || SHORT="agenthub suggest failed"
  echo "ERROR=$SHORT" >&2
  echo "LIKELY_CAUSE=agenthub suggest failed (index/runtime issue)." >&2
  echo "RECOVERY=agenthub_doctor" >&2
  exit "$SUGGEST_RC"
fi

RECOMMENDED="$(printf '%s\n' "$SUGGEST_OUT" | sed -n 's/^RECOMMENDED=//p' | head -n 1)"
if [[ -z "$RECOMMENDED" || "$RECOMMENDED" == "NONE" ]]; then
  RECOMMENDED="$(printf '%s\n' "$SUGGEST_OUT" | sed -n 's/^CARD=SKILL=\([^ ]*\).*/\1/p' | head -n 1)"
fi
if [[ -z "$RECOMMENDED" || "$RECOMMENDED" == "NONE" ]]; then
  RECOMMENDED="<choose_skill>"
fi

TASK_NAME="$("$ROOT/bin/agenthub" task-name --skill "$RECOMMENDED" | sed -n 's/^TASK_NAME=//p' | head -n 1)"
if [[ -z "$TASK_NAME" ]]; then
  TASK_NAME="<skill>_<timestamp>"
fi

REQ_DIR="$ROOT/AGENTS/requests"
mkdir -p "$REQ_DIR"
REQ_PATH="$REQ_DIR/${TASK_NAME}.md"
if [[ ! -f "$REQ_PATH" ]]; then
  cat > "$REQ_PATH" <<EOF
# Request

Goal:
$QUERY

Background:
- Auto-generated from bart input. Refine as needed.

Constraints:
- Do not modify USER/ unless explicitly requested.

Deliverables:
- A report under AGENTS/tasks/<task_id>/review/.
EOF
fi

REQ_REL="${REQ_PATH#$ROOT/}"

echo "RECOMMENDED_SKILL=$RECOMMENDED"
echo "TASK_NAME=$TASK_NAME"
echo "START_PENDING=true"
echo "HINT=Request template at $REQ_REL"
