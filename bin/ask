#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ $# -lt 1 ]]; then
  echo "Usage: ./bin/ask \"<free text request>\"" >&2
  exit 2
fi

QUERY="$*"

SUGGEST_OUT="$($ROOT/bin/agenthub suggest "$QUERY")"
printf '%s\n' "$SUGGEST_OUT"

RECOMMENDED="$(printf '%s\n' "$SUGGEST_OUT" | sed -n 's/^RECOMMENDED=//p' | head -n 1)"
if [[ -z "$RECOMMENDED" || "$RECOMMENDED" == "NONE" ]]; then
  RECOMMENDED="<choose_from_cards>"
fi

TASK_NAME="$(printf '%s' "$QUERY" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9' '_' | sed 's/^_*//; s/_*$//' | cut -c1-40)"
[[ -n "$TASK_NAME" ]] || TASK_NAME="task"

echo ""
echo "NEXT_COMMAND=cat <<'EOF' | ./bin/agenthub start --skill $RECOMMENDED --task-name $TASK_NAME --request -"
echo "request:"
echo "  goal: TBD"
echo "  constraints:"
echo "    - TBD"
echo "  inputs:"
echo "    - TBD"
echo "EOF"
echo ""
echo "THEN_RUN=./bin/agenthub run --task <TASK_ID>"
